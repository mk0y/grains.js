!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).Grains={})}(this,(function(t){"use strict";const e=new Set(["click","mouseover","mouseout","mouseenter","mouseleave","submit","change","input","focus","blur","keyup","keydown","keypress","scroll","resize","load","unload","beforeunload"]),n={STATE:"[g-state]",INTERACTIVE:Array.from(e).map((t=>`[g-on\\:${t}]`)).join(", ")+", [g-action]",DYNAMIC:"[g-text], [g-show], [g-class], [g-disabled], [g-attr], [g-model]",get ALL(){return`${this.STATE},${this.INTERACTIVE},${this.DYNAMIC}`}},r=["g-state","g-init","g-text","g-class","g-action","g-args","g-disabled","g-show","g-attr","g-model"];class s{static cacheElements(t){const e={textElements:Array.from(t.querySelectorAll("[g-text]")),showElements:Array.from(t.querySelectorAll("[g-show]")),interactiveElements:Array.from(t.querySelectorAll(n.INTERACTIVE)),allElements:Array.from(t.querySelectorAll(n.ALL))};return this.cache.set(t,e),e}static getCache(t){return this.cache.get(t)}static clearCache(t){this.cache.delete(t)}}function o(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var i,a;function c(){if(a)return i;function t(t){return t instanceof Buffer?Buffer.from(t):new t.constructor(t.buffer.slice(),t.byteOffset,t.length)}return a=1,i=function(e){if((e=e||{}).circles)return function(e){const n=[],r=[],s=new Map;if(s.set(Date,(t=>new Date(t))),s.set(Map,((t,e)=>new Map(i(Array.from(t),e)))),s.set(Set,((t,e)=>new Set(i(Array.from(t),e)))),e.constructorHandlers)for(const t of e.constructorHandlers)s.set(t[0],t[1]);let o=null;return e.proto?c:a;function i(e,i){const a=Object.keys(e),c=Array(a.length);for(let l=0;a.length>l;l++){const u=a[l],f=e[u];if("object"!=typeof f||null===f)c[u]=f;else if(f.constructor!==Object&&(o=s.get(f.constructor)))c[u]=o(f,i);else if(ArrayBuffer.isView(f))c[u]=t(f);else{const t=n.indexOf(f);c[u]=-1!==t?r[t]:i(f)}}return c}function a(e){if("object"!=typeof e||null===e)return e;if(Array.isArray(e))return i(e,a);if(e.constructor!==Object&&(o=s.get(e.constructor)))return o(e,a);const c={};n.push(e),r.push(c);for(const i in e){if(!1===Object.hasOwnProperty.call(e,i))continue;const l=e[i];if("object"!=typeof l||null===l)c[i]=l;else if(l.constructor!==Object&&(o=s.get(l.constructor)))c[i]=o(l,a);else if(ArrayBuffer.isView(l))c[i]=t(l);else{const t=n.indexOf(l);c[i]=-1!==t?r[t]:a(l)}}return n.pop(),r.pop(),c}function c(e){if("object"!=typeof e||null===e)return e;if(Array.isArray(e))return i(e,c);if(e.constructor!==Object&&(o=s.get(e.constructor)))return o(e,c);const a={};n.push(e),r.push(a);for(const i in e){const l=e[i];if("object"!=typeof l||null===l)a[i]=l;else if(l.constructor!==Object&&(o=s.get(l.constructor)))a[i]=o(l,c);else if(ArrayBuffer.isView(l))a[i]=t(l);else{const t=n.indexOf(l);a[i]=-1!==t?r[t]:c(l)}}return n.pop(),r.pop(),a}}(e);const n=new Map;if(n.set(Date,(t=>new Date(t))),n.set(Map,((t,e)=>new Map(s(Array.from(t),e)))),n.set(Set,((t,e)=>new Set(s(Array.from(t),e)))),e.constructorHandlers)for(const t of e.constructorHandlers)n.set(t[0],t[1]);let r=null;return e.proto?function e(o){if("object"!=typeof o||null===o)return o;if(Array.isArray(o))return s(o,e);if(o.constructor!==Object&&(r=n.get(o.constructor)))return r(o,e);const i={};for(const s in o){const a=o[s];i[s]="object"!=typeof a||null===a?a:a.constructor!==Object&&(r=n.get(a.constructor))?r(a,e):ArrayBuffer.isView(a)?t(a):e(a)}return i}:function e(o){if("object"!=typeof o||null===o)return o;if(Array.isArray(o))return s(o,e);if(o.constructor!==Object&&(r=n.get(o.constructor)))return r(o,e);const i={};for(const s in o){if(!1===Object.hasOwnProperty.call(o,s))continue;const a=o[s];i[s]="object"!=typeof a||null===a?a:a.constructor!==Object&&(r=n.get(a.constructor))?r(a,e):ArrayBuffer.isView(a)?t(a):e(a)}return i};function s(e,s){const o=Object.keys(e),i=Array(o.length);for(let a=0;o.length>a;a++){const c=o[a],l=e[c];i[c]="object"!=typeof l||null===l?l:l.constructor!==Object&&(r=n.get(l.constructor))?r(l,s):ArrayBuffer.isView(l)?t(l):s(l)}return i}},i}s.cache=new WeakMap;const l=o(c())();function u(t){return l(t)}function f(t){let e=t;for(;e;){if(e.hasAttribute("g-state"))return e;e=e.parentElement}return null}function g(t,e){if(!t||"string"!=typeof e||0===e.length)return;const n=e.split(".");let r=t;for(const t of n){if(null==r||!r.hasOwnProperty(t))return;r=r[t]}return r}function d(t,e,n){if(!t||"string"!=typeof e||0===e.length)return;const r=e.split(".");let s=t;for(let t=0;r.length-1>t;t++){const e=r[t];s.hasOwnProperty(e)||(s[e]={}),s=s[e]}s[r[r.length-1]]=n}const p=new class{constructor(){this.grains=new Map,this.history=new Map}clear(){this.grains.clear(),this.history.clear()}set(t,e){this.grains.set(t,e)}get(t){return this.grains.get(t)}delete(t){this.grains.delete(t),this.history.delete(t)}getHistory(t){return this.history.get(t)}initHistory(t){this.history.set(t,{past:[],future:[]})}getAllStates(){return this.grains.entries()}},h={canUndo:t=>{const e=t.getAttribute("g-state").split(":")[0],n=p.getHistory(e);return!!n&&n?.past.length>0},canRedo:t=>{const e=t.getAttribute("g-state").split(":")[0],n=p.getHistory(e);return!!n&&n?.future.length>0},isPositive:(t,e)=>g(t.$grain,e)>0,isNegative:(t,e)=>0>g(t.$grain,e),isEmpty:(t,e)=>{const n=g(t.$grain,e);return 0===n||""===n||null===n},equals:(t,e,n)=>g(t.$grain,e)===n};function y(t,e){const n=f(t);if(!n)return!1;try{if(e in h)return h[e](n);if(e.startsWith("!")&&e.slice(1)in h)return!h[e.slice(1)](n);const t=e.replace(/(\w+)\((.*?)\)/g,((t,e,r)=>{if(e in h){const t=r.split(",").map((t=>(t=t.trim()).startsWith("'")||t.startsWith('"')?t.slice(1,-1):isNaN(Number(t))?t:Number(t)));return""+h[e](n,...t)}return t})),r=function(t){return t.$grain}(n);return Function(...Object.keys(r),"return "+t)(...Object.values(r))}catch(t){return console.error(`Error evaluating expression "${e}":`,t),!1}}const m=":",b=new Set(["disabled","checked","readonly","required","hidden","selected","multiple","novalidate"]),w=new Set(["src","href","alt","title","class","id","name","value","type","placeholder","disabled","checked","readonly","required","aria-label","aria-describedby","role","style","data-*"]);function A(t,e){return t.includes(m)?t.split(",").map((t=>t.trim())).filter((t=>t.includes(m))).map((t=>{const[e,...n]=t.split(m),r=n.join(m).trim();return{attr:e.trim(),expression:r}})).filter((({attr:t,expression:n})=>function(t,e,n){return t?e?/^[a-zA-Z0-9\-_]+$/.test(t)||t.startsWith("data-")||t.startsWith("aria-")?(w.has(t)||t.startsWith("data-")||t.startsWith("aria-")||console.warn(`Potentially invalid HTML attribute "${t}" in g-attr directive:`,n),!(e.includes("{")&&!e.includes("}")&&(console.warn(`Unclosed placeholder in expression "${e}" for attribute "${t}":`,n),1))):(console.warn(`Invalid attribute name "${t}" in g-attr directive. Use only letters, numbers, hyphens, and underscores:`,n),!1):(console.warn(`Empty expression for attribute "${t}" in g-attr directive:`,n),!1):(console.warn("Empty attribute name in g-attr directive:",n),!1)}(t,n,e))):(console.warn('Invalid g-attr syntax. Use "attribute: expression" format:',e),[])}function E(t,e,n){e.forEach((({attr:e,expression:r})=>{try{let i;if(r.startsWith("{")&&r.endsWith("}")){const e=r.slice(1,-1);e.includes("<")||e.includes(">")||e.includes("&&")||e.includes("||")?i=y(t,e):(i=(s=n,o=r,o.replace(/\{([^}]+)\}/g,((t,e)=>JSON.stringify(g(s.$grain,e))))).replace(/^"(.*)"$/,"$1"),"true"===i&&(i=!0),"false"===i&&(i=!1),"null"===i&&(i=null),"undefined"===i&&(i=void 0))}else i=y(t,r);const a=e.toLowerCase();if(b.has(a)){return void(!0==!!i?t.setAttribute(e,""):t.removeAttribute(e))}null==i||"null"===i||"undefined"===i?t.removeAttribute(e):t.setAttribute(e,i+"")}catch(t){console.error(`Error updating attribute "${e}":`,t)}var s,o}))}function v(t,e){return new Proxy(t,{get(t,n){const r=Reflect.get(t,n);return r&&"object"==typeof r&&!Array.isArray(r)?v(r,e):r},set(t,n,r){const s=Reflect.get(t,n),o=Reflect.set(t,n,r);return s!==r&&requestAnimationFrame((()=>e())),o},deleteProperty(t,n){const r=n in t,s=Reflect.deleteProperty(t,n);return r&&requestAnimationFrame((()=>e())),s}})}function $(t){return t instanceof HTMLInputElement}function j(t){return t instanceof HTMLTextAreaElement}function O(t){return t instanceof HTMLSelectElement}const x={"g-text":function(t,e){const n=e.replace(/[{}]/g,"").trim(),r=f(t);if(r&&r.$grain){const e=g(r.$grain,n);t.textContent=null==e?"":e+""}else t.textContent=""},"g-show":function(t,e){"originalDisplay"in t.dataset||(t.dataset.originalDisplay=t.style.display||getComputedStyle(t).display);const n=y(t,e);t.style.display=n?t.dataset.originalDisplay:"none"},"g-disabled":function(t,e){t instanceof HTMLButtonElement&&(t.disabled=y(t,e))},"g-class":function(t){f(t)?function(t){const e=t.getAttribute("g-class");if(!e)return;const n=function(t){try{return t.startsWith("[")?t.slice(1,-1).trim().split(",").map((t=>t.trim())):[t.trim()]}catch(t){return console.error("[Grains.js] Error parsing class expression:",t),null}}(e);if(!n)return;n.forEach((e=>{const n=function(t,e){try{if(e.match(/^['"].*['"]$/))return e.slice(1,-1).split(" ");if(/^[a-zA-Z0-9-_\s]+$/.test(e))return e.split(" ");if(e.includes("&&")){const[n,r]=e.split("&&").map((t=>t.trim()));return!!y(t,n)&&r.replace(/['"]/g,"").split(" ")}return!!y(t,e)&&e.split(" ")}catch(t){return console.error("[Grains.js] Error evaluating class condition:",t),null}}(t,e);if(Array.isArray(n))n.forEach((e=>{e&&t.classList.add(e.trim())}));else if("string"==typeof n)t.classList.add(n);else if(!1===n){const n=e.split("&&")[1]?.trim().replace(/['"]/g,"");n&&n.split(" ").forEach((e=>{t.classList.remove(e.trim())}))}}))}(t):console.warn("No parent grain element found for g-class directive:",t)},"g-attr":function(t,e){const n=f(t);if(!n)return void console.warn("No parent grain element found for g-attr directive:",t);E(t,A(e,t),n)},"g-model":function(t,e){const n=f(t);if(!n)return;const r=e,s=n.$grain[r];$(t)?"checkbox"===t.type?t.checked=s??!1:t.value=s??"":(j(t)||O(t))&&(t.value=s??"");const o=()=>{$(t)?d(n.$grain,r,"checkbox"===t.type?t.checked:t.value):(j(t)||O(t))&&d(n.$grain,r,t.value),L(n)};O(t)?t.addEventListener("change",o):t.addEventListener("input",o),v(n.$grain,(()=>{$(t)?"checkbox"===t.type?t.checked=n.$grain[r]??!1:t.value=n.$grain[r]??"":(j(t)||O(t))&&(t.value=n.$grain[r]??"")})),n.$cleanup=()=>{t.removeEventListener("input",o),t.removeEventListener("change",o)}}};function S(t){for(const e of r)if(t.hasAttribute(e)){const n=t.getAttribute(e),r=x[e];r&&r(t,n)}}class M{static scheduleUpdate(t){this.pendingUpdates.add(t),this.frameRequested||(this.frameRequested=!0,requestAnimationFrame((()=>this.processUpdates())))}static processUpdates(){for(const t of this.pendingUpdates){const e=s.getCache(t)||s.cacheElements(t);for(const t of e.allElements)t instanceof HTMLElement&&S(t)}this.pendingUpdates.clear(),this.frameRequested=!1}static forceUpdate(t){const e=s.getCache(t)||s.cacheElements(t);for(const t of e.allElements)t instanceof HTMLElement&&S(t);this.pendingUpdates.delete(t)}}function L(t){M.scheduleUpdate(t)}function T(t,e,n){return async r=>{r.preventDefault();let s=[];if(t.hasAttribute("g-args"))try{if(s=JSON.parse(t.getAttribute("g-args")),!Array.isArray(s))throw Error("g-args must be an array")}catch(e){return void console.error("[Grains.js] Invalid g-args format. Must be a valid JSON array. Element:",t,"\nError:",e)}"submit"===e&&t instanceof HTMLFormElement&&s.push(t,r);try{const e=f(t);if(!e)return void console.warn("[Grains.js] No parent grain element found. Event handler cannot be executed. Element:",t);await function(t,e,n,r=[]){const s=window[e];if("function"!=typeof s)throw Error(`Function '${e}' not defined`);const o=t.getAttribute("g-state").split(":")[0],i=p.getHistory(o),a=Object.fromEntries(Array.from(p.getAllStates()).filter((([t])=>t!==o)).map((([t,e])=>[t,{get:t=>g(e,t),set:n=>{const r=document.querySelector(`[g-state^="${t}"]`);if(r){const s=p.getHistory(t),o=u(e);Object.assign(e,{...u(e),...n}),s.past.push(o),s.past.length>50&&s.past.shift(),s.future=[],M.scheduleUpdate(r)}}}]))),c={get:e=>g(t.$grain,e),set:e=>{const n={...u(t.$grain),...e};if(JSON.stringify(n)!==JSON.stringify(t.$grain)){const e=u(t.$grain);Object.assign(t.$grain,n),i.past.push(e),i.past.length>50&&i.past.shift(),i.future=[],M.scheduleUpdate(t)}},getState:()=>u(t.$grain),undo:()=>{if(i.past.length>0){const e=u(t.$grain),n=i.past.pop();i.future.push(e),Object.assign(t.$grain,n),L(t)}},redo:()=>{if(i.future.length>0){const e=u(t.$grain),n=i.future.pop();i.past.push(e),Object.assign(t.$grain,n),L(t)}},canUndo:()=>i.past.length>0,canRedo:()=>i.future.length>0,states:new Proxy(a,{get:(t,e)=>("string"!=typeof e||e in t||console.warn(`[Grains.js] attempting to access non-existent state "${e}"`),t[e])})},l=s(c,r);return Promise.resolve(l)}(e,n,0,s)}catch(r){console.error(`[Grains.js] Error in ${e} handler "${n}":`,r,"\nElement:",t)}}}function N(t,n){Array.from(t.attributes).forEach((r=>{if(r.name.startsWith("g-on:")){const s=r.name.substring(5),o=r.value;if(!function(t,n){return!!e.has(t)||(console.warn(`[Grains.js] Invalid event type "${t}" in g-on:${t}. Element:`,n,"\nValid events are: "+Array.from(e).join(", ")),!1)}(s,t))return;if(!function(t,e){return t?"function"==typeof window[t]||(console.warn(`[Grains.js] Function "${t}" not found in global scope. Make sure it's defined before the element. Element:`,e),!1):(console.warn("[Grains.js] Empty function name provided for event handler. Element:",e),!1)}(o,t))return;const i=T(t,s,o);t.addEventListener(s,i),n.has(t)||n.set(t,new Map),n.get(t).set(s,i)}}))}function H(t,e){if(t.hasAttribute("g-action")){const n=function(t){const e=t.getAttribute("g-action");return e&&["undo","redo"].includes(e)?async n=>{n.preventDefault();const r=f(t);if(!r)return void console.warn("[Grains.js] No parent grain element found for action handler. Element:",t);const s=r.getAttribute("g-state");if(!s)return void console.warn("[Grains.js] No g-state attribute found on grain element. Element:",r);const o=p.getHistory(s.split(":")[0]);if(o){if("undo"===e&&o.past.length>0){const t=u(r.$grain),e=o.past.pop();o.future.push(t),Object.assign(r.$grain,e),L(r)}else if("redo"===e&&o.future.length>0){const t=u(r.$grain),e=o.future.pop();o.past.push(t),Object.assign(r.$grain,e),L(r)}}else console.warn("[Grains.js] No history found for state:",s)}:(console.warn('[Grains.js] Invalid g-action value. Must be either "undo" or "redo". Element:',t),async()=>{})}(t);t.addEventListener("click",n),e.has(t)||e.set(t,new Map),e.get(t).set("click",n)}}function U(t){const[e,n]=t.getAttribute("g-state").split(":"),r=function(t){const e=t.getAttribute("g-init");if(e)try{return JSON.parse(e)}catch(n){const r=e.trim();if(r in window){const e=window[r];return"object"==typeof e?e:(console.error(`[Grains.js] Global variable "${r}" is not an object. Using empty object. Grain: `,t),{})}return console.warn(`[Grains.js] g-init attribute "${r}" is neither valid JSON nor a reference to a global object variable. Using empty object as initial state. Grain: `,t),{}}return{}}(t);p.initHistory(e),t.$grain=u(r);const o=s.cacheElements(t);for(const t of o.allElements)t instanceof HTMLElement&&S(t);const i=v(r,(()=>{M.scheduleUpdate(t)}));p.set(e,i),t.$grain=i,t.$cleanup=()=>{p.delete(e),s.clearCache(t),delete window[e]},window[e]=i,function(t){const e=new Map,n=s.getCache(t)||s.cacheElements(t);for(const t of n.interactiveElements)N(t,e),H(t,e);t.$cleanup=()=>{e.forEach(((t,e)=>{t.forEach(((t,n)=>{e.removeEventListener(n,t)}))})),e.clear()}}(t)}function k(){p.clear();const t=document.querySelectorAll(n.STATE);for(const e of t)U(e)}M.pendingUpdates=new Set,M.frameRequested=!1,window.addEventListener("DOMContentLoaded",k),t.bootstrap=k,t.grainStore=p}));
//# sourceMappingURL=grains.min.js.map
